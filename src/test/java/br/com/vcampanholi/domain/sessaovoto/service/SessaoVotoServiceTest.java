package br.com.vcampanholi.domain.sessaovoto.service;import br.com.vcampanholi.domain.sessao.repository.entity.SessaoEntity;import br.com.vcampanholi.domain.sessao.service.SessaoService;import br.com.vcampanholi.domain.sessaovoto.repository.SessaoVotoRepository;import br.com.vcampanholi.exception.GenericException;import br.com.vcampanholi.integration.model.UserResponse;import br.com.vcampanholi.integration.model.UserStatusEnum;import br.com.vcampanholi.integration.restclient.UserRestClient;import br.com.vcampanholi.stubs.entity.SessaoEntityStub;import br.com.vcampanholi.stubs.entity.SessaoVotoEntityStub;import br.com.vcampanholi.stubs.request.SessaoVotoRequestStub;import org.junit.jupiter.api.BeforeEach;import org.junit.jupiter.api.Test;import org.junit.jupiter.api.extension.ExtendWith;import org.mockito.InjectMocks;import org.mockito.Mock;import org.springframework.http.HttpStatus;import org.springframework.test.context.junit.jupiter.SpringExtension;import java.time.LocalDateTime;import java.util.ArrayList;import java.util.List;import static org.junit.jupiter.api.Assertions.*;import static org.mockito.ArgumentMatchers.any;import static org.mockito.Mockito.when;@ExtendWith(SpringExtension.class)class SessaoVotoServiceTest {    @Mock    private SessaoService sessaoService;    @Mock    private UserRestClient userRestClient;    @Mock    private SessaoVotoRepository sessaoVotoRepository;    @InjectMocks    private SessaoVotoService sessaoVotoService;    private SessaoEntity sessaoEntity;    private UserResponse userResponse;    @BeforeEach    void setUp() {        sessaoEntity = SessaoEntityStub.entityToReturn();        userResponse = new UserResponse(UserStatusEnum.ABLE_TO_VOTE);    }    @Test    void deveRegistarVotoDeUmAssociado() {        sessaoEntity.setDataHoraAbertura(LocalDateTime.now().minusMinutes(10));        sessaoEntity.setDataHoraEncerramento(LocalDateTime.now().plusMinutes(20));        when(userRestClient.buscarUsuario(any())).thenReturn(userResponse);        when(sessaoService.buscarSessao(any())).thenReturn(sessaoEntity);        when(sessaoVotoRepository.existsBySessaoIdAndCpfAssociado(any(), any())).thenReturn(Boolean.FALSE);        assertAll(() -> sessaoVotoService.registarVoto(1L, 1L, SessaoVotoRequestStub.sessaoVotoRequest()));    }    @Test    void deveRetornarExceptionQuandoSessaoEstiverEncerradaComDataMenor() {        sessaoEntity.setDataHoraAbertura(LocalDateTime.now().minusMinutes(10));        sessaoEntity.setDataHoraEncerramento(LocalDateTime.now().minusMinutes(5));        when(userRestClient.buscarUsuario(any())).thenReturn(userResponse);        when(sessaoService.buscarSessao(any())).thenReturn(sessaoEntity);        when(sessaoVotoRepository.existsBySessaoIdAndCpfAssociado(any(), any())).thenReturn(Boolean.FALSE);        var thrown = assertThrows(GenericException.class, () ->                sessaoVotoService.registarVoto(1L, 1L, SessaoVotoRequestStub.sessaoVotoRequest()));        assertEquals("Período de votação não está aberto para esta sessão", thrown.getMessage());        assertEquals(HttpStatus.BAD_REQUEST, thrown.getStatus());    }    @Test    void deveRetornarExceptionQuandoSessaoEstiverEncerradaComDataMaior() {        sessaoEntity.setDataHoraAbertura(LocalDateTime.now().plusMinutes(20));        sessaoEntity.setDataHoraEncerramento(LocalDateTime.now().plusMinutes(10));        when(userRestClient.buscarUsuario(any())).thenReturn(userResponse);        when(sessaoService.buscarSessao(any())).thenReturn(sessaoEntity);        when(sessaoVotoRepository.existsBySessaoIdAndCpfAssociado(any(), any())).thenReturn(Boolean.FALSE);        var thrown = assertThrows(GenericException.class, () ->                sessaoVotoService.registarVoto(1L, 1L, SessaoVotoRequestStub.sessaoVotoRequest()));        assertEquals("Período de votação não está aberto para esta sessão", thrown.getMessage());        assertEquals(HttpStatus.BAD_REQUEST, thrown.getStatus());    }    @Test    void deveRetornarExceptionQuandoSessaoNaoPertenceAPauta() {        sessaoEntity.setDataHoraAbertura(LocalDateTime.now().minusMinutes(10));        sessaoEntity.setDataHoraEncerramento(LocalDateTime.now().plusMinutes(20));        when(userRestClient.buscarUsuario(any())).thenReturn(userResponse);        when(sessaoService.buscarSessao(any())).thenReturn(sessaoEntity);        when(sessaoVotoRepository.existsBySessaoIdAndCpfAssociado(any(), any())).thenReturn(Boolean.FALSE);        var thrown = assertThrows(GenericException.class, () ->                sessaoVotoService.registarVoto(3L, 1L, SessaoVotoRequestStub.sessaoVotoRequest()));        assertEquals("Sessão não pertence à pauta informada", thrown.getMessage());        assertEquals(HttpStatus.BAD_REQUEST, thrown.getStatus());    }    @Test    void deveRetornarExceptionQuandoCpfDoAssociadoForInvalido() {        sessaoEntity.setDataHoraAbertura(LocalDateTime.now().minusMinutes(10));        sessaoEntity.setDataHoraEncerramento(LocalDateTime.now().plusMinutes(20));        userResponse.setStatus(UserStatusEnum.INVALID);        when(userRestClient.buscarUsuario(any())).thenReturn(userResponse);        when(sessaoService.buscarSessao(any())).thenReturn(sessaoEntity);        when(sessaoVotoRepository.existsBySessaoIdAndCpfAssociado(any(), any())).thenReturn(Boolean.FALSE);        var thrown = assertThrows(GenericException.class, () ->                sessaoVotoService.registarVoto(3L, 1L, SessaoVotoRequestStub.sessaoVotoRequest()));        assertEquals("CPF do asociado é inválido", thrown.getMessage());        assertEquals(HttpStatus.BAD_REQUEST, thrown.getStatus());    }    @Test    void deveRetornarExceptionQuandoAssociadoNaoEstaHabilitadoPaaraVotar() {        sessaoEntity.setDataHoraAbertura(LocalDateTime.now().minusMinutes(10));        sessaoEntity.setDataHoraEncerramento(LocalDateTime.now().plusMinutes(20));        userResponse.setStatus(UserStatusEnum.UNABLE_TO_VOTE);        when(userRestClient.buscarUsuario(any())).thenReturn(userResponse);        when(sessaoService.buscarSessao(any())).thenReturn(sessaoEntity);        when(sessaoVotoRepository.existsBySessaoIdAndCpfAssociado(any(), any())).thenReturn(Boolean.FALSE);        var thrown = assertThrows(GenericException.class, () ->                sessaoVotoService.registarVoto(3L, 1L, SessaoVotoRequestStub.sessaoVotoRequest()));        assertEquals("Associado não pode votar nesta sessão", thrown.getMessage());        assertEquals(HttpStatus.BAD_REQUEST, thrown.getStatus());    }    @Test    void deveRetornarExceptionQuandoAssociadoJaVotouNaSessao() {        sessaoEntity.setDataHoraAbertura(LocalDateTime.now().minusMinutes(10));        sessaoEntity.setDataHoraEncerramento(LocalDateTime.now().plusMinutes(20));        when(userRestClient.buscarUsuario(any())).thenReturn(userResponse);        when(sessaoService.buscarSessao(any())).thenReturn(sessaoEntity);        when(sessaoVotoRepository.existsBySessaoIdAndCpfAssociado(any(), any())).thenReturn(Boolean.TRUE);        var thrown = assertThrows(GenericException.class, () ->                sessaoVotoService.registarVoto(1L, 1L, SessaoVotoRequestStub.sessaoVotoRequest()));        assertEquals("Associado com CPF: 18979793049 já computou seu voto nesta sessão", thrown.getMessage());        assertEquals(HttpStatus.BAD_REQUEST, thrown.getStatus());    }    @Test    void deveRetornarTodosOsVotosDeUmaSessaoPorPauta() {        when(sessaoVotoRepository.findBySessaoPautaId(any()))                .thenReturn(List.of(SessaoVotoEntityStub.sessaoVotoEntity()));        var response = sessaoVotoService.buscarVotosDaSessaoPorPauta(1L);        assertEquals(response, List.of(SessaoVotoEntityStub.sessaoVotoEntity()));    }    @Test    void deveRetornarUmaListaVaziaQuandoNaoEncontrarVotosParaAPauta() {        when(sessaoVotoRepository.findBySessaoPautaId(any())).thenReturn(new ArrayList<>());        var response = sessaoVotoService.buscarVotosDaSessaoPorPauta(1L);        assertEquals(response, new ArrayList<>());    }}